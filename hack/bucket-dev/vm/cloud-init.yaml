#cloud-config
# Cloud-init for the bucket-agent Multipass VM.
#
# This only writes config files and creates directories.
# Binary installation is done by setup.sh AFTER the native mount is ready,
# by calling install-from-bucket.sh via multipass exec.

package_update: false

write_files:
  # containerd config
  - path: /etc/containerd/config.toml
    content: |
      version = 2
      [plugins."io.containerd.grpc.v1.cri"]
        sandbox_image = "registry.k8s.io/pause:3.9"
        [plugins."io.containerd.grpc.v1.cri".containerd]
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
            runtime_type = "io.containerd.runc.v2"
            [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
              SystemdCgroup = true

  # kubelet config
  - path: /var/lib/kubelet/config.yaml
    content: |
      apiVersion: kubelet.config.k8s.io/v1beta1
      kind: KubeletConfiguration
      authentication:
        x509:
          clientCAFile: /etc/kubernetes/pki/ca.crt
        anonymous:
          enabled: false
      authorization:
        mode: Webhook
      cgroupDriver: systemd
      containerRuntimeEndpoint: unix:///run/containerd/containerd.sock
      resolvConf: /run/systemd/resolve/resolv.conf
      failSwapOn: false

  # kubelet systemd unit
  - path: /etc/systemd/system/kubelet.service
    content: |
      [Unit]
      Description=kubelet
      After=containerd.service
      Requires=containerd.service

      [Service]
      ExecStart=/usr/local/bin/kubelet \
        --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \
        --config=/var/lib/kubelet/config.yaml \
        --hostname-override=NODE_ID_PLACEHOLDER \
        --v=2
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

  # bucket-proxy-agent systemd unit
  - path: /etc/systemd/system/bucket-proxy-agent.service
    content: |
      [Unit]
      Description=Bucket Proxy Agent
      After=network.target

      [Service]
      ExecStart=/usr/local/bin/bucket-proxy-agent \
        --bucket-dir=/mnt/bucket \
        --node-id=NODE_ID_PLACEHOLDER \
        --poll-interval=0 \
        --v=4
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

  # Install script that pulls everything from the bucket
  - path: /usr/local/bin/install-from-bucket.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      BASE=/mnt/bucket/distributables

      # Detect architecture and select the right subdirectory.
      ARCH=$(uname -m)
      case "$ARCH" in
        x86_64)  ARCH_DIR="$BASE/amd64" ;;
        aarch64) ARCH_DIR="$BASE/arm64" ;;
        *) echo "ERROR: unsupported arch $ARCH"; exit 1 ;;
      esac

      echo "==> Installing from bucket distributables ($ARCH_DIR)..."

      if [ ! -d "$ARCH_DIR" ]; then
        echo "ERROR: $ARCH_DIR not found. Is the bucket mounted?"
        exit 1
      fi

      # Install required deb packages (offline, ignore errors for optional deps)
      if ls "$ARCH_DIR/debs"/*.deb >/dev/null 2>&1; then
        echo "==> Installing deb packages from bucket..."
        dpkg -i "$ARCH_DIR/debs"/*.deb 2>&1 || true
      fi

      # Install containerd
      if [ ! -f /usr/local/bin/containerd ]; then
        echo "==> Installing containerd..."
        tar -C /usr/local -xzf "$ARCH_DIR/containerd.tar.gz"
        cp "$BASE/containerd.service" /etc/systemd/system/containerd.service
        cp "$ARCH_DIR/runc" /usr/local/sbin/runc
        chmod +x /usr/local/sbin/runc
        mkdir -p /opt/cni/bin
        tar -C /opt/cni/bin -xzf "$ARCH_DIR/cni-plugins.tgz"
      else
        echo "==> containerd already installed, skipping"
      fi

      # Install minimal CNI config (bridge + host-local IPAM).
      # No CNI daemon needed — this makes kubelet report the node as Ready.
      mkdir -p /etc/cni/net.d
      echo '{"cniVersion":"1.0.0","name":"bridge","plugins":[{"type":"bridge","bridge":"cni0","isGateway":true,"ipMasq":true,"ipam":{"type":"host-local","subnet":"10.244.0.0/24"}},{"type":"loopback"}]}' > /etc/cni/net.d/10-bridge.conflist

      # Install kubelet and kubectl
      echo "==> Installing kubelet and kubectl..."
      cp "$ARCH_DIR/kubelet" /usr/local/bin/kubelet
      chmod +x /usr/local/bin/kubelet
      cp "$ARCH_DIR/kubectl" /usr/local/bin/kubectl
      chmod +x /usr/local/bin/kubectl

      # Install bucket-proxy-agent
      echo "==> Installing bucket-proxy-agent..."
      if [ -f "$ARCH_DIR/bucket-proxy-agent" ]; then
        cp "$ARCH_DIR/bucket-proxy-agent" /usr/local/bin/bucket-proxy-agent
        chmod +x /usr/local/bin/bucket-proxy-agent
      else
        echo "WARNING: bucket-proxy-agent not found in $ARCH_DIR"
      fi

      # Start containerd
      echo "==> Starting containerd..."
      systemctl daemon-reload
      systemctl enable --now containerd
      sleep 3

      # Import pause image if available
      if [ -f "$ARCH_DIR/pause.tar" ]; then
        echo "==> Importing pause image..."
        ctr -n k8s.io images import "$ARCH_DIR/pause.tar" 2>&1 || true
      fi

      # Copy PKI material from bucket
      BUCKET=/mnt/bucket
      if [ -d "$BUCKET/pki" ]; then
        echo "==> Installing PKI from bucket..."
        cp "$BUCKET/pki/ca.crt" /etc/kubernetes/pki/ca.crt
        cp "$BUCKET/pki/kubelet.kubeconfig" /etc/kubernetes/kubelet.kubeconfig
      else
        echo "WARNING: $BUCKET/pki not found, skipping PKI install"
      fi

      # Read the node ID injected into the bucket by the control plane.
      if [ -f "$BUCKET/pki/node-id" ]; then
        NODE_ID=$(cat "$BUCKET/pki/node-id" | tr -d '[:space:]')
        echo "==> Node ID from bucket: $NODE_ID"
        # Substitute the placeholder in systemd unit files.
        sed -i "s/NODE_ID_PLACEHOLDER/$NODE_ID/g" /etc/systemd/system/kubelet.service
        sed -i "s/NODE_ID_PLACEHOLDER/$NODE_ID/g" /etc/systemd/system/bucket-proxy-agent.service
      else
        echo "ERROR: $BUCKET/pki/node-id not found — cannot configure services"
        exit 1
      fi

      # Start services
      echo "==> Starting services..."
      systemctl daemon-reload
      if [ -f /etc/kubernetes/kubelet.kubeconfig ] && \
         [ -f /usr/local/bin/bucket-proxy-agent ]; then
        systemctl enable --now bucket-proxy-agent
        systemctl enable --now kubelet
      else
        echo "WARNING: Skipping service start — missing kubeconfig or agent binary"
      fi

      echo "==> Installation from bucket complete."

runcmd:
  # Create directories only — binary installation happens later via setup.sh
  # after the native mount is established.
  - mkdir -p /mnt/bucket
  - mkdir -p /etc/kubernetes/pki
